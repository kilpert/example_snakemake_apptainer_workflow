bootstrap: docker
From: condaforge/miniforge3:latest


## Usage:

## Build .sif from this definition file:
## apptainer build --force --build-arg 'ENVIRONMENT_YAML=workflow/envs/bedtools.yaml' containers/bedtools.sif workflow/envs/apptainer.def

## Run the container:
## apptainer run containers/bedtools.sif conda info
## apptainer run containers/bedtools.sif conda list
## apptainer run containers/bedtools.sif bedtools --version
## apptainer run -B "$PWD":/work --pwd /work containers/bedtools.sif bedtools intersect -a test/a.bed -b test/b.bed | tee c.bed


%labels
    Author "you"
    Description "miniforge3 + bedtools"

## Copy the environment file into the build context
%files
    {{ ENVIRONMENT_YAML }} /opt/env/environment.yaml

%post
    ## -e: exit on error, -u: treat unset variables as an error, -x: print commands before executing them
    set -eux 

    ## Create a home directory   
    mkdir -p /opt/home 

    ## List contents of the environment directory for debugging
    ls -l /opt/env/

    ## Ensure conda is on PATH
    export PATH=/opt/conda/bin:$PATH

    ## Configure channels (strict order: conda-forge then bioconda)
    conda config --system --add channels bioconda
    conda config --system --add channels conda-forge
    conda config --system --set channel_priority strict

    ## Update conda to the latest version
    conda update -n base -c conda-forge conda -y -q
    ## Install everything from the YAML *into base*
    conda env update -n base -f /opt/env/environment.yaml
    
    ## Clean
    conda clean -afy

%environment
    export HOME=/opt/home
    export PATH=/opt/conda/bin:$PATH
    export CONDARC=/opt/conda/.condarc
    export CONDA_PKGS_DIRS=/opt/conda/pkgs
    export CONDA_ENVS_PATH=/opt/conda/envs
    unset CONDA_PREFIX CONDA_DEFAULT_ENV CONDA_SHLVL

%test
    ## %environment is only active during runtime, but NOT during test!!!
    export HOME=/opt/home
    export PATH=/opt/conda/bin:$PATH
    export CONDARC=/opt/conda/.condarc
    export CONDA_PKGS_DIRS=/opt/conda/pkgs
    export CONDA_ENVS_PATH=/opt/conda/envs
    unset CONDA_PREFIX CONDA_DEFAULT_ENV CONDA_SHLVL
    
    ## List installed packages
    conda list

%runscript
    exec env -i \
      HOME=/opt/home \
      PATH=/opt/conda/bin:/usr/bin:/bin \
      CONDARC=/opt/conda/.condarc \
      CONDA_PKGS_DIRS=/opt/conda/pkgs \
      CONDA_ENVS_PATH=/opt/conda/envs \
      "$@"
