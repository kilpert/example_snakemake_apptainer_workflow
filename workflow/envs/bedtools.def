bootstrap: docker
From: condaforge/miniforge3:latest

%labels
    Author you
    Description "miniforge3 + bedtools"

# Copy the environment file into the build context
%files
    {{ ENVIRONMENT_YAML }} /opt/env/environment.yaml

%post
    mkdir -p /opt/home

    set -eux
    # Ensure conda is on PATH
    export PATH=/opt/conda/bin:$PATH

    # Configure channels (strict order: conda-forge then bioconda)
    conda config --system --set channel_priority strict
    conda config --system --add channels conda-forge
    conda config --system --add channels bioconda

    ls -l /opt/env/

    # Update conda to the latest version
    conda update -n base -c conda-forge conda -y -q
    # Install everything from the YAML *into base*
    conda env update -n base -f /opt/env/environment.yaml
    ## conda install -y bedtools

    # Clean
    conda clean -afy

%environment
    export HOME=/opt/home
    export PATH=/opt/conda/bin:$PATH
    export CONDARC=/opt/conda/.condarc
    export CONDA_PKGS_DIRS=/opt/conda/pkgs
    export CONDA_ENVS_PATH=/opt/conda/envs
    unset CONDA_PREFIX CONDA_DEFAULT_ENV CONDA_SHLVL

%test
    export HOME=/opt/home
    export PATH=/opt/conda/bin:$PATH
    export CONDARC=/opt/conda/.condarc
    export CONDA_PKGS_DIRS=/opt/conda/pkgs
    export CONDA_ENVS_PATH=/opt/conda/envs
    unset CONDA_PREFIX CONDA_DEFAULT_ENV CONDA_SHLVL
    
    ## List installed packages
    conda list

%runscript
    exec env -i \
      HOME=/opt/home \
      PATH=/opt/conda/bin:/usr/bin:/bin \
      CONDARC=/opt/conda/.condarc \
      CONDA_PKGS_DIRS=/opt/conda/pkgs \
      CONDA_ENVS_PATH=/opt/conda/envs \
      "$@"
